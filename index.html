 <!DOCTYPE html>
<html>
<head>
    <title>Route Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .status { margin-top: 10px; color: #666; font-size: 12px; }
        .button {
            background: #1E90FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 12px;
        }
        .button:hover { background: #0080FF; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <strong>Route: E 12th St → S Santa Fe Ave</strong><br>
        Distance: <span id="distance">0.9 mi</span><br>
        Duration: <span id="duration">4 mins</span><br>
        <div class="status" id="location-status">Waiting for location from Draftbit...</div>
        <button class="button" onclick="showRoute()">Refresh Route</button>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userMarker;

        // Route coordinates
        const startPoint = { lat: 34.0225823, lng: -118.2274002 };
        const endPoint = { lat: 34.0134287, lng: -118.2296891 };

        function initMap() {
            console.log('Initializing map...');
            
            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: { lat: 34.0177, lng: -118.2289 },
                mapTypeId: "roadmap",
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                suppressMarkers: false,
            });
            directionsRenderer.setMap(map);

            // Add start marker (green)
            new google.maps.Marker({
                position: startPoint,
                map: map,
                title: "Start: E 12th St",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                }
            });

            // Add end marker (red)
            new google.maps.Marker({
                position: endPoint,
                map: map,
                title: "End: S Santa Fe Ave",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                }
            });

            // Check URL for location from Draftbit
            checkURLForLocation();

            // Automatically show route
            showRoute();

            console.log('Map initialization complete');
        }

        function checkURLForLocation() {
            const params = new URLSearchParams(window.location.search);
            const lat = params.get('lat');
            const lng = params.get('lng');
            
            if (lat && lng) {
                console.log('Location received from Draftbit:', lat, lng);
                showUserLocation(parseFloat(lat), parseFloat(lng));
            } else {
                console.log('No location parameters in URL');
                document.getElementById('location-status').innerHTML = 
                    'No location received. Use "Get Location" button in app.';
            }
        }

        function showUserLocation(lat, lng) {
            console.log('Showing user location:', lat, lng);
            
            // Remove previous user marker
            if (userMarker) {
                userMarker.setMap(null);
            }

            // Add blue user marker
            userMarker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                title: "Your Location",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
            });

            // Update status
            document.getElementById('location-status').innerHTML = 
                `✓ Your location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        }

        function showRoute() {
            console.log('Showing route...');
            
            const request = {
                origin: startPoint,
                destination: endPoint,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL,
            };

            directionsService.route(request, function(result, status) {
                if (status === "OK") {
                    console.log('Route loaded successfully');
                    directionsRenderer.setDirections(result);
                    
                    // Update distance and duration
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    document.getElementById('distance').innerHTML = leg.distance.text;
                    document.getElementById('duration').innerHTML = leg.duration.text;
                } else {
                    console.error('Route error:', status);
                    document.getElementById('distance').innerHTML = 'Route error';
                    document.getElementById('duration').innerHTML = 'Route error';
                }
            });
        }
    </script>
<script>
  document.addEventListener('message', (event) => {
    const { lat, lng } = JSON.parse(event.data);
    updateDot(lat, lng); // your function that moves the marker
  });
</script>
<div id="map"> … </div>
<div id="dot"> … </div>
<script>
  function updateDot(lat, lng) {
    // move dot based on lat/lng (your existing logic)
  }

  document.addEventListener('message', event => {
    try {
      const { lat, lng } = JSON.parse(event.data);
      updateDot(lat, lng);
    } catch (e) {
      console.log('Bad message', e);
    }
  });
</script>

    <!-- Load Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap">
    </script>
</body>
</html>
