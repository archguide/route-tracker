<!DOCTYPE html>
<html>
<head>
    <title>Route Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 250px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .status { margin-top: 10px; color: #666; font-size: 12px; }
        .button {
            background: #1E90FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="info-panel">
        <strong>Route: E 12th St â†’ S Santa Fe Ave</strong><br>
        Distance: <span id="distance">Calculating...</span><br>
        Duration: <span id="duration">Calculating...</span><br>
        <div class="status" id="location-status">Looking for location data...</div>
        <button class="button" onclick="showRoute()">Show Route</button>
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let userMarker;
        let locationCheckInterval;

        // Route coordinates
        const startPoint = { lat: 34.0225823, lng: -118.2274002 };
        const endPoint = { lat: 34.0134287, lng: -118.2296891 };

        function initMap() {
            // Initialize map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: { lat: 34.0177, lng: -118.2289 },
                mapTypeId: "roadmap",
            });

            // Initialize directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                draggable: false,
                suppressMarkers: false,
            });
            directionsRenderer.setMap(map);

            // Add start marker
            new google.maps.Marker({
                position: startPoint,
                map: map,
                title: "Start: E 12th St",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                }
            });

            // Add end marker
            new google.maps.Marker({
                position: endPoint,
                map: map,
                title: "End: S Santa Fe Ave",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                }
            });

            // Check for location in URL parameters
            checkURLForLocation();

            // Listen for postMessage from Draftbit
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'location') {
                    updateUserLocation(event.data.lat, event.data.lng);
                }
            });

            // Check for Draftbit variables periodically
            startLocationMonitoring();

            // Automatically show route on load
            showRoute();
        }

        function startLocationMonitoring() {
            // Check every 2 seconds for location data from Draftbit
            locationCheckInterval = setInterval(() => {
                checkForDraftbitLocation();
            }, 2000);
        }

        function checkForDraftbitLocation() {
            // Method 1: Check if parent window has location data
            try {
                if (window.parent && window.parent !== window) {
                    // Try to access parent's location data
                    if (window.parent.userLocation && 
                        window.parent.userLocation.coords &&
                        window.parent.userLocation.coords.latitude) {
                        
                        const lat = window.parent.userLocation.coords.latitude;
                        const lng = window.parent.userLocation.coords.longitude;
                        updateUserLocation(lat, lng);
                        clearInterval(locationCheckInterval);
                        return;
                    }
                }
            } catch (e) {
                // Cross-origin access blocked, that's normal
            }

            // Method 2: Check localStorage for location data
            try {
                const storedLocation = localStorage.getItem('draftbitUserLocation');
                if (storedLocation) {
                    const locationData = JSON.parse(storedLocation);
                    if (locationData.lat && locationData.lng) {
                        updateUserLocation(locationData.lat, locationData.lng);
                        clearInterval(locationCheckInterval);
                        return;
                    }
                }
            } catch (e) {
                // localStorage not available
            }

            // Method 3: Check global variables
            if (window.draftbitLat && window.draftbitLng) {
                updateUserLocation(window.draftbitLat, window.draftbitLng);
                clearInterval(locationCheckInterval);
                return;
            }

            // Method 4: Check for coordinates in document title or meta tags
            const titleMatch = document.title.match(/lat:([\d.-]+),lng:([\d.-]+)/);
            if (titleMatch) {
                updateUserLocation(parseFloat(titleMatch[1]), parseFloat(titleMatch[2]));
                clearInterval(locationCheckInterval);
                return;
            }
        }

        function checkURLForLocation() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = urlParams.get('lat');
            const lng = urlParams.get('lng');
            
            if (lat && lng) {
                updateUserLocation(parseFloat(lat), parseFloat(lng));
                clearInterval(locationCheckInterval);
            }
        }

        function updateUserLocation(lat, lng) {
            const userPos = { lat: lat, lng: lng };

            // Remove previous user marker
            if (userMarker) {
                userMarker.setMap(null);
            }

            // Add user marker
            userMarker = new google.maps.Marker({
                position: userPos,
                map: map,
                title: "Your Location",
                icon: {
                    url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                }
            });

            // Update status
            document.getElementById('location-status').innerHTML = 
                `Your location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;

            console.log('Location updated:', lat, lng);
        }

        function showRoute() {
            const request = {
                origin: startPoint,
                destination: endPoint,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL,
                avoidHighways: false,
                avoidTolls: false,
            };

            directionsService.route(request, (result, status) => {
                if (status === "OK") {
                    directionsRenderer.setDirections(result);
                    
                    // Update distance and duration
                    const route = result.routes[0];
                    const leg = route.legs[0];
                    
                    document.getElementById('distance').innerHTML = leg.distance.text;
                    document.getElementById('duration').innerHTML = leg.duration.text;
                } else {
                    console.error('Directions request failed due to ' + status);
                    document.getElementById('distance').innerHTML = 'Error';
                    document.getElementById('duration').innerHTML = 'Error';
                }
            });
        }

        // Global functions that can be called from outside
        window.updateLocation = function(lat, lng) {
            updateUserLocation(lat, lng);
        };

        // Function to set location via global variables
        window.setDraftbitLocation = function(lat, lng) {
            window.draftbitLat = lat;
            window.draftbitLng = lng;
            updateUserLocation(lat, lng);
        };
    </script>

    <!-- Load Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDDdD8BAz34j_0zv-G3qJKTP5sKQn7PQ1w&callback=initMap&libraries=geometry" async defer></script>
</body>
</html>
